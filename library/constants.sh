#!/bin/bash


# TODO: Write description
######################################################################
# library/constants.sh - Script for 
#
#
######################################################################


# MULTIPLE SOURCING GUARD

# Prevent multiple sourcing of this script by exiting if CONSTANTS_SH_INCLUDED
# is already set. Otherwise, set CONSTANTS_SH_INCLUDED to mark it as sourced.
[[ -n "${CONSTANTS_SH_INCLUDED}" ]] && return
CONSTANTS_SH_INCLUDED=1

# SOURCE DEPENDENCIES

LIBRARY_SCRIPTS_DIRECTORY_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Source all custom functions scripts from "qpb_parameters_scan/library" using a
# loop avoiding this way name-specific sourcing and thus potential typos
for library_script in "$LIBRARY_SCRIPTS_DIRECTORY_PATH";
do
    # Check if the current file in the loop is a regular file
    if [ -f "$library_script" ]; then
        source "$library_script"
    fi
done
unset LIBRARY_SCRIPTS_DIRECTORY_PATH

# CONSTANTS DEFINITIONS

# NON-ITERABLE PARAMETERS

NON_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "OVERLAP_OPERATOR_METHOD" \
        "KERNEL_OPERATOR_TYPE" \
        "QCD_BETA_VALUE" \
        "LATTICE_DIMENSIONS"
    )

OVERLAP_OPERATOR_METHOD="Bare"
KERNEL_OPERATOR_TYPE="Standard"
QCD_BETA_VALUE="6.20"
LATTICE_DIMENSIONS="48 24 24 24"

# ITERABLE PARAMETERS

# Common iterable parameters to all main programs
COMMON_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "GAUGE_LINKS_CONFIGURATION_LABEL" \
        "NUMBER_OF_VECTORS" \
        "APE_ITERATIONS" \
        "APE_ALPHA" \
        "CLOVER_TERM_COEFFICIENT" \
        "BARE_MASS"
    )

# Initialize common iterable parameters with default values
GAUGE_LINKS_CONFIGURATION_LABEL="0000000"
NUMBER_OF_VECTORS="1"
APE_ITERATIONS="0"
APE_ALPHA="0.72"
CLOVER_TERM_COEFFICIENT="0"
BARE_MASS="0.0"

# Additional common iterable parameters to all "invert" main programs
COMMON_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "SOLVER_EPSILON" \
        "SOLVER_MAX_ITERATIONS"
    )

# Initialize "invert" common iterable parameters with default values
SOLVER_EPSILON=1e-8
SOLVER_MAX_ITERATIONS=10000

# Operator-specific iterable parameters:

# Additional iterable parameters common to all bare operator main programs
BARE_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "KAPPA_VALUE"
    )

# Initialize bare-operator-specific iterable parameters with default values
KAPPA_VALUE="0.125"

# Additional iterable parameters common to all overlap operator main programs
COMMON_OVERLAP_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "RHO_VALUE" \
    )

# Initialize common overlap operator iterable parameters with default values
RHO_VALUE="1.0"

# Additional iterable parameters common to all "Chebyshev" main programs
CHEBYSHEV_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "NUMBER_OF_CHEBYSHEV_TERMS" \
        "LANCZOS_EPSILON" \
        "LANCZOS_MAX_ITERATIONS" \
        "DELTA_MIN" \
        "DELTA_MAX"
    )

# Initialize Chebyshev-specific iterable parameters with default values
NUMBER_OF_CHEBYSHEV_TERMS=10
LANCZOS_EPSILON="1e-10"
LANCZOS_MAX_ITERATIONS="10000"
DELTA_MIN="1.0"
DELTA_MAX="1.0"

# Additional iterable parameters common to all "KL" main programs
KL_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "KL_DIAGONAL_ORDER" \
        "SOLVER_INNER_EPSILON" \
        "SOLVER_INNER_MAX_ITERATIONS" \
        "SCALING_FACTOR"
    )

# Initialize KL-specific iterable parameters with default values
KL_DIAGONAL_ORDER="1"
SOLVER_INNER_EPSILON=1e-10
SOLVER_INNER_MAX_ITERATIONS=10000
SCALING_FACTOR="1.0"

# Additional iterable parameters common to all "Neuberger" main programs
NEUBERGER_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "KL_DIAGONAL_ORDER" \
        "SOLVER_INNER_EPSILON" \
        "SOLVER_INNER_MAX_ITERATIONS" \
        "SCALING_FACTOR"
    )

# Initialize Neuberger-specific iterable parameters with default values
# NOTE: Neuberger uses the same parameters as KL, so we reuse the KL defaults
# The values are already initialized in the KL section above

# Additional iterable parameters common to all "Zolotarev" main programs
ZOLOTAREV_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY=(
        "ZOLOTAREV_ORDER" \
        "SCALING_FACTOR" \
        "LANCZOS_EPSILON" \
        "LANCZOS_MAX_ITERATIONS" \
        "DELTA_MIN" \
        "DELTA_MAX"
    )

# Initialize Zolotarev-specific iterable parameters with default values
ZOLOTAREV_ORDER="1"
# NOTE: SCALING_FACTOR, LANCZOS_EPSILON, LANCZOS_MAX_ITERATIONS, DELTA_MIN, 
# and DELTA_MAX are already initialized in the KL and Chebyshev sections above

# Construct various iterable parameters names arrays by combining the above

# Bare
BARE_ITERABLE_PARAMETERS_NAMES_ARRAY=(${COMMON_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
BARE_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${BARE_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Bare invert
BARE_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY=(${BARE_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
BARE_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Chebyshev
CHEBYSHEV_ITERABLE_PARAMETERS_NAMES_ARRAY=(${COMMON_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
CHEBYSHEV_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_OVERLAP_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
CHEBYSHEV_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${CHEBYSHEV_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Chebyshev invert
CHEBYSHEV_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY=(${CHEBYSHEV_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
CHEBYSHEV_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# KL
KL_ITERABLE_PARAMETERS_NAMES_ARRAY=(${COMMON_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
KL_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_OVERLAP_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
KL_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${KL_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# KL invert
KL_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY=(${KL_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
KL_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Neuberger
NEUBERGER_ITERABLE_PARAMETERS_NAMES_ARRAY=(${COMMON_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
NEUBERGER_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_OVERLAP_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
NEUBERGER_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${NEUBERGER_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Neuberger invert
NEUBERGER_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY=(${NEUBERGER_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
NEUBERGER_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Zolotarev
ZOLOTAREV_ITERABLE_PARAMETERS_NAMES_ARRAY=(${COMMON_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
ZOLOTAREV_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_OVERLAP_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
ZOLOTAREV_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${ZOLOTAREV_SPECIFIC_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Zolotarev invert
ZOLOTAREV_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY=(${ZOLOTAREV_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})
ZOLOTAREV_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY+=(${COMMON_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY[@]})

# Pass the names of the above iterable parameters arrays to a dictionary
declare -A ITERABLE_PARAMETERS_NAMES_DICTIONARY
ITERABLE_PARAMETERS_NAMES_DICTIONARY["Bare"]="BARE_ITERABLE_PARAMETERS_NAMES_ARRAY"
ITERABLE_PARAMETERS_NAMES_DICTIONARY["Bare_invert"]="BARE_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY"

ITERABLE_PARAMETERS_NAMES_DICTIONARY["Chebyshev"]="CHEBYSHEV_ITERABLE_PARAMETERS_NAMES_ARRAY"
ITERABLE_PARAMETERS_NAMES_DICTIONARY["Chebyshev_invert"]="CHEBYSHEV_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY"

ITERABLE_PARAMETERS_NAMES_DICTIONARY["KL"]="KL_ITERABLE_PARAMETERS_NAMES_ARRAY"
ITERABLE_PARAMETERS_NAMES_DICTIONARY["KL_invert"]="KL_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY"

ITERABLE_PARAMETERS_NAMES_DICTIONARY["Neuberger"]="NEUBERGER_ITERABLE_PARAMETERS_NAMES_ARRAY"
ITERABLE_PARAMETERS_NAMES_DICTIONARY["Neuberger_invert"]="NEUBERGER_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY"

ITERABLE_PARAMETERS_NAMES_DICTIONARY["Zolotarev"]="ZOLOTAREV_ITERABLE_PARAMETERS_NAMES_ARRAY"
ITERABLE_PARAMETERS_NAMES_DICTIONARY["Zolotarev_invert"]="ZOLOTAREV_INVERT_ITERABLE_PARAMETERS_NAMES_ARRAY"

# VARYING ITERABLE PARAMETERS

# List of array names containing varying parameter values
VARYING_PARAMETERS_SET_OF_VALUES_ARRAYS_NAMES=(
    "INNER_LOOP_VARYING_PARAMETER_SET_OF_VALUES" \
    "OUTER_LOOP_VARYING_PARAMETER_SET_OF_VALUES" \
    "OVERALL_OUTER_LOOP_VARYING_PARAMETER_SET_OF_VALUES"
    )

# MODIFIABLE PARAMETERS PRINTING LABELS

declare -A MODIFIABLE_PARAMETERS_LABELS_DICTIONARY

# Non-iterable parameters
# NOTE: Unnecessary to include OVERLAP_OPERATOR_METHOD and KERNEL_OPERATOR_TYPE
# parameters
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["QCD_BETA_VALUE"]="beta"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["LATTICE_DIMENSIONS"]="LatticeDims"
# Iterable parameters labels
# Common to all
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["GAUGE_LINKS_CONFIGURATION_LABEL"]="config"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["NUMBER_OF_VECTORS"]="NVecs"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["APE_ITERATIONS"]="APEiters"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["APE_ALPHA"]="APEalpha"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["RHO_VALUE"]="rho"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["KAPPA_VALUE"]="kappa"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["BARE_MASS"]="m"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["CLOVER_TERM_COEFFICIENT"]="cSW"
# Common invert
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["SOLVER_EPSILON"]="EpsCG"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["SOLVER_MAX_ITERATIONS"]="CGMaxIters"
# Chebyshev-specific
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["NUMBER_OF_CHEBYSHEV_TERMS"]="N"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["LANCZOS_EPSILON"]="EpsLanczos"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["LANCZOS_MAX_ITERATIONS"]="LanczosMaxIters"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["DELTA_MIN"]="dMin"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["DELTA_MAX"]="dMax"
# KL-specific
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["KL_DIAGONAL_ORDER"]="n"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["SOLVER_INNER_EPSILON"]="EpsMSCG"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["SOLVER_INNER_MAX_ITERATIONS"]="MSCGMaxIters"
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["SCALING_FACTOR"]="mu"
# Neuberger-specific (same as KL, so no new labels needed)
# Zolotarev-specific
MODIFIABLE_PARAMETERS_LABELS_DICTIONARY["ZOLOTAREV_ORDER"]="ZolOrder"

# MODIFIABLE PARAMETERS VALUE CHECK FUNCTIONS

declare -A MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY

# Non-iterable parameters
# NOTE: Unnecessary to include validation functions for non-iterable parameters
# Iterable parameters
# Common to all
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["GAUGE_LINKS_CONFIGURATION_LABEL"]="is_valid_gauge_links_configuration_label"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["NUMBER_OF_VECTORS"]="is_positive_integer"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["APE_ITERATIONS"]="is_non_negative_integer"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["APE_ALPHA"]="is_positive_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["RHO_VALUE"]="is_valid_rho_value"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["KAPPA_VALUE"]="is_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["BARE_MASS"]="is_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["CLOVER_TERM_COEFFICIENT"]="is_valid_clover_term_coefficient"
# Common invert
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["SOLVER_EPSILON"]="is_positive_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["SOLVER_MAX_ITERATIONS"]="is_positive_integer"
# Chebyshev-specific
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["NUMBER_OF_CHEBYSHEV_TERMS"]="is_positive_integer"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["LANCZOS_EPSILON"]="is_positive_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["LANCZOS_MAX_ITERATIONS"]="is_positive_integer"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["DELTA_MIN"]="is_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["DELTA_MAX"]="is_float"
# KL-specific
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["KL_DIAGONAL_ORDER"]="is_positive_integer"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["SOLVER_INNER_EPSILON"]="is_positive_float"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["SOLVER_INNER_MAX_ITERATIONS"]="is_positive_integer"
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["SCALING_FACTOR"]="is_positive_float"
# Neuberger-specific (same as KL, so no new validation functions needed)
# Zolotarev-specific
MODIFIABLE_PARAMETERS_VALIDATION_FUNCTIONS_DICTIONARY["ZOLOTAREV_ORDER"]="is_positive_integer"

# TODO: Remove this dictionary it is redundant
# MODIFIABLE PARAMETERS VALUES GENERATORS FROM RANGE

declare -A MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY

# NOTE: There can't be values generators from range for non-iterable parameters
# Iterable parameters
# Common to all
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["GAUGE_LINKS_CONFIGURATION_LABEL"]="range_of_gauge_configurations_file_paths_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["NUMBER_OF_VECTORS"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["APE_ITERATIONS"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["APE_ALPHA"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["RHO_VALUE"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["KAPPA_VALUE"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["BARE_MASS"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["CLOVER_TERM_COEFFICIENT"]="general_range_of_values_generator"
# Common invert
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["SOLVER_EPSILON"]="exponential_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["SOLVER_MAX_ITERATIONS"]="general_range_of_values_generator"
# Chebyshev-specific
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["NUMBER_OF_CHEBYSHEV_TERMS"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["LANCZOS_EPSILON"]="exponential_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["LANCZOS_MAX_ITERATIONS"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["DELTA_MIN"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["DELTA_MAX"]="general_range_of_values_generator"
# KL-specific
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["KL_DIAGONAL_ORDER"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["SOLVER_INNER_EPSILON"]="exponential_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["SOLVER_INNER_MAX_ITERATIONS"]="general_range_of_values_generator"
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["SCALING_FACTOR"]="general_range_of_values_generator"
# Neuberger-specific (same as KL, so no new generators needed)
# Zolotarev-specific
MODIFIABLE_PARAMETERS_RANGE_OF_VALUES_GENERATORS_DICTIONARY["ZOLOTAREV_ORDER"]="general_range_of_values_generator"
